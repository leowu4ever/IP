<html>
  <head>
    
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width, user-scalable=no,
      shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
      
    <style>
      @import 'ui/css/evothings-app.css';
    </style>

    <script>
    // Redirect console.log to Evothings Workbench.	
    if (window.hyper && window.hyper.log) { console.log = hyper.log}
    </script>
   	<script src="libs/plotly-latest.min.js"></script>
    <script src="cordova.js"></script>
    <script src="crafty.js"></script>
    <script src="libs/evothings/evothings.js"></script>
    <script src="libs/evothings/ui/ui.js"></script>
  	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
    
  </head>
   <body>
    <div>
     <button onclick="getBestMatching()" class="green">
	       test
	   </button>
      <button onclick="plot()" class="green">
	       plot
	   </button>
    </div>
    
   	 <div id="x" style="width: 500px; height: 500px; float:left"><!-- Plotly chart will be drawn inside this DIV --></div>
     <div id="z" style="width: 500px; height: 500px; float:right"><!-- Plotly chart will be drawn inside this DIV --></div>
   	 <div id="y" style="width: 500px; height: 500px; margin: 0 auto"><!-- Plotly chart will be drawn inside this DIV --></div>

     <script>
      
      var data_0 = [[0,0,1],[0,0.01,1],[0.01,0,1],[0.01,0,0.99],[0,0,1],[0,0.01,1],[-0.01,0,1],[0,0.01,1],[-0.01,0.01,1.01],[-0.01,0.01,1.01],[-0.01,0,1.02],[-0.01,0,1.01],[-0.01,0,1],[-0.01,0,1.02],[-0.01,-0.01,0.99],[-0.01,0,0.99],[-0.01,-0.01,1],[0,0,1],[-0.01,-0.01,0.99],[0.01,0,1],[0,0,1],[0,0,1],[0,-0.01,1.01],[0,0,0.99],[-0.01,-0.01,0.99],[0,0,0.99],[0.01,0.02,1],[0,0.01,1],[0,0.01,1],[-0.01,0.01,1],[-0.01,0,0.99],[-0.01,0,1],[-0.01,0.01,1]]
      var data_1 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0.01,0,1],[0.01,0.01,1],[-0.01,0,1.01],[-0.01,0.01,1],[-0.01,0,1],[-0.01,0,1],[-0.01,0,1.01],[0,0.01,1],[-0.02,-0.01,1],[-0.01,0.01,1],[0,0,1],[0,0,1],[-0.01,0,1],[-0.01,-0.01,1],[-0.01,0,1],[0,0,1],[-0.01,0,1],[-0.01,0,1],[0,0,1],[-0.01,-0.01,1],[0,0,1],[0,-0.01,1],[0,0,0.99],[0,0,1],[0.01,0.01,0.99],[0,0.01,1],[0,0.01,1],[0,0,1],[0,0.01,1],[0,0.01,1],[-0.01,0.01,1],[0,0,1]]
      var data_2 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0.01,0.01,1],[0,0,1],[0,0,1],[0.01,0.02,1.01],[-0.01,0,1.01],[-0.01,0.01,1.01],[-0.01,0.01,0.98],[-0.01,0.01,0.99],[-0.01,0,1],[-0.01,-0.01,1],[-0.01,-0.01,1],[-0.01,-0.01,1],[0,-0.01,1],[0,-0.01,1],[0,-0.01,0.99],[0.01,-0.01,0.99],[0,-0.01,1],[0,0,0.99],[0.01,0.01,1],[0.01,0.01,1.01],[0.01,0.01,1],[0,0.01,1],[-0.01,0,0.99],[-0.02,0,1],[-0.01,0,1],[0,0,1.01],[0,0,1.01],[0,0,1]]
      var data_3 = [[0,0,1],[0,0,1],[0,0.01,1],[0,0,1],[0.01,0,1],[0.01,0,1],[0.01,0.02,1.01],[0,0.01,0.99],[-0.02,-0.01,0.99],[-0.01,0,1],[0,0.01,1],[0,0,1],[-0.01,-0.01,0.99],[-0.03,-0.01,1],[-0.01,-0.01,0.99],[-0.01,-0.02,1.01],[-0.01,-0.02,0.99],[0.01,-0.01,1],[0.02,0.01,1],[0,-0.01,1],[0.01,-0.01,0.99],[0.01,0,1.02],[0.01,0.01,0.99],[0.01,0,1],[0.01,0.01,1],[0.01,0.01,1],[-0.01,0.01,1],[-0.02,0.01,1.01],[-0.01,0,1],[0,0,0.99],[0,0,1],[0,0,1]]
      var data_4 = [[0,0,1],[0,0,1],[0,0,1],[0,0.01,1],[0.02,0.01,0.99],[0,0.01,1],[-0.01,0.01,1],[-0.01,0.01,0.99],[-0.01,0.02,0.96],[-0.02,-0.01,1.01],[-0.01,-0.01,0.97],[-0.01,-0.01,1],[0,-0.01,1],[0,-0.02,1],[0,0,1],[0,-0.02,0.99],[0.01,-0.02,1],[0.02,0.01,1],[0.01,0,0.98],[0.01,0.01,0.99],[0.01,0.01,1.01],[0,0.01,1],[0,0.01,1],[-0.01,0,1],[-0.01,0,1.01],[0,0,1],[0,0,1],[0,0,1],[-0.01,0,1]]
      var data_5 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0.01,0,1],[0.01,0.02,1],[0,0.01,0.99],[-0.01,0.01,1],[-0.01,0.02,0.99],[0,0.01,0.99],[-0.01,0,1.01],[-0.01,-0.01,1],[-0.02,-0.01,0.99],[0,-0.02,1],[0.01,-0.01,1],[0,-0.02,0.99],[-0.01,-0.03,0.99],[0.01,0,1],[0.01,0,1],[0.01,0,0.99],[0.01,0.01,1],[0,0.01,0.99],[0,0.01,1],[0,0.01,1],[-0.01,0,0.99],[0,0,0.99],[0,0,1],[0,0,1],[0,0,1]]
      var data_6 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1.01],[0.01,0.01,1],[0,0.01,0.99],[0.01,0.01,0.99],[0,0.01,1],[-0.01,0,1],[-0.01,0.01,0.99],[-0.01,0,1.01],[-0.01,-0.01,0.99],[-0.01,0,0.99],[-0.01,-0.01,1],[0,-0.01,1],[0,-0.01,1],[0,-0.01,1.01],[0,-0.01,1],[0,-0.01,0.99],[0.01,-0.01,1.01],[0.01,0,0.99],[0,0,1.01],[0,0.01,0.98],[0,0,0.99],[0,0.01,1],[-0.01,0,1],[-0.01,0,1],[0,0,1.01],[0,0,1],[0,0,1]]
      var data_7 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0.01,0.01,1.01],[0,0.01,1],[-0.01,0.01,1],[-0.01,0.01,1.01],[0,0.01,0.98],[-0.02,-0.01,1],[-0.01,0,0.99],[-0.01,-0.01,1.01],[-0.02,-0.01,0.99],[-0.01,-0.01,1],[0,-0.01,1],[0,-0.01,1],[0.01,-0.01,1],[0.01,0,1],[0.01,0,0.99],[0.01,0,1],[0.01,0,1],[0.01,0.01,1],[0.01,0.01,1],[0.01,0.01,1],[0,0.01,1],[-0.02,0,1],[0,0,1],[0,0,1],[0,-0.01,1]]
      var data_8 = [[0,0,1],[0,0,1],[0,0,0.99],[0.01,0,1],[0.01,0.01,1],[0.02,0.02,1],[-0.01,0.01,1.01],[-0.01,0.01,1],[-0.01,0.01,1],[-0.01,0,0.99],[-0.01,-0.01,0.99],[-0.01,-0.01,1],[-0.01,-0.02,1],[-0.01,-0.02,1],[-0.01,-0.02,1],[0,-0.01,0.99],[0,-0.02,0.99],[0,-0.01,1],[0,0,1],[0.01,0.01,0.99],[0,0.01,1],[0,0.01,0.99],[0,0,1],[-0.01,0,1],[-0.01,0,1],[0,0,1],[-0.01,0,1],[0,0,1],[0,0,1]]
      var data_9 = [[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0.01,0.01,1],[0.01,0.01,1],[0,0.01,0.99],[-0.02,0,1],[-0.01,0.01,0.99],[0,0,1.01],[-0.02,0,1],[-0.02,0,1],[-0.01,-0.02,0.99],[-0.01,-0.02,0.99],[0.01,-0.03,1],[-0.01,-0.02,0.99],[-0.01,-0.02,1],[0,-0.01,1],[0.01,0,1.01],[0.01,0.01,1],[0.02,0.02,1],[0.01,0.01,0.99],[0,0.02,1.01],[-0.01,0.01,1],[-0.01,0.01,1],[-0.02,0,1],[-0.01,0,1],[0,0,0.99]]

      
      var dataset = [data_1, data_2, data_3, data_5, data_6, data_7, data_8, data_9]
     
      function getBestMatching () {
        var result = []
        var temp = interpolate(segment(smooth(testData)))
        result.push(getReadingDistance(dataset[0], temp))
        result.push(getReadingDistance(dataset[1], temp))
        result.push(getReadingDistance(dataset[2], temp))
        result.push(getReadingDistance(dataset[3], temp))
        result.push(getReadingDistance(dataset[4], temp))
        result.push(getReadingDistance(dataset[5], temp))
        result.push(getReadingDistance(dataset[6], temp))
        result.push(getReadingDistance(dataset[7], temp))
        result.push(getReadingDistance(dataset[8], temp))
        result.push(getReadingDistance(dataset[9], temp))
      
        var index = minIndex(result)
        hyper.log(result)
        hyper.log(index)
        return index
      }

      function minIndex(arr) {
        if (!arr || arr.length === 0) {
          return -1;
        }
        var min = arr[0];
        var minIndex = 0;
        for (var len = arr.length; len > 0; len--) {
          if (arr[len] < min) {
            min = arr[len];
            minIndex = len;
          }
        }
        return minIndex;
      }
      
      function getMeanData () {
        var ds = [] 
        for (a = 0; a < dataset.length; a++) {
          ds[a] = interpolate(segment(smooth(dataset[a])))
        }
        var temp = []

        for (i = 0; i < ds[0].length; i++) {
          var x = 0.0
          var y = 0.0
          var z = 0.0
          for (j = 0; j < ds.length; j++) {
            x += ds[j][i][0]
            y += ds[j][i][1]
            z += ds[j][i][2]
          }
          x /= ds.length
          y /= ds.length
          z /= ds.length
          temp[i] = [x, y, z]
        }
        printReading(temp)
        return temp
      }

      function printReading (reading) {
        var log = ""
        for (i = 0; i < reading.length; i++) {
          if ( i != reading.length -1 ) { log += "[" + reading[i] + "]" + "," } 
          else { log += "[" + reading[i] + "]" }
        }
        hyper.log (log)
      }

      function getReadingDistance (r1, r2) {
        var dis = 0.0;
        for (i = 0; i < r1.length; i++) {
          dis += getDistance (r1[i], r2[i])
        }
        return dis
      }
      
      // remove the first two and last two data
      var segmentThreshold = 3
      function segment(reading) {
        var temp = reading.slice()
        for (i = 0; i < segmentThreshold; i++){
          temp.splice(0, 1)
          temp.splice(temp.length-1, 1)
        }
          return temp
      }

      var smoothThreshold = 0.3
      function smooth (reading) {
        var smoothReading = []
        for (i = 0; i < reading.length; i++) {
          v_x = reading[i][0]
          v_y = reading[i][1]
          v_z = reading[i][2]
          if (i == 0) {
            smoothReading.push ([v_x, v_y, v_z])
          } else {
            s_x = smoothReading[i-1][0]
            s_y = smoothReading[i-1][1]
            s_z = smoothReading[i-1][2]
            smoothReading.push ([ (s_x + smoothThreshold * (v_x - s_x)), (s_y + smoothThreshold * (v_y - s_y)), (s_z + smoothThreshold * (v_z - s_z)) ])
          }
        }
        return smoothReading
      }
      
      function getAxis (reading, axis) {
        var axis_record = []
        for (i = 0; i < reading.length; i++) {
          axis_record.push (reading[i][axis])
        }
        return axis_record
      }

      // http://www.hevi.info/2012/03/interpolating-and-array-to-fit-another-size/
      var interpolateThreshold = 100
      function linearInterpolate(before, after, atPoint) {
	      return before + (after - before) * atPoint;
      }

      function interpolateArray(data, fitCount) {
        var newData = new Array();
        var springFactor = new Number((data.length - 1) / (fitCount - 1));
        newData[0] = data[0]; // for new allocation
        for ( var i = 1; i < fitCount - 1; i++) {
          var tmp = i * springFactor;
          var before = new Number(Math.floor(tmp)).toFixed();
          var after = new Number(Math.ceil(tmp)).toFixed();
          var atPoint = tmp - before;
          newData[i] = this.linearInterpolate(data[before], data[after], atPoint);
        }
        newData[fitCount - 1] = data[data.length - 1]; // for new allocation
        return newData;
      }

      function interpolate (reading) {
        var xnew = interpolateArray(getAxis(reading, 0), interpolateThreshold)
        var ynew = interpolateArray(getAxis(reading, 1), interpolateThreshold)
        var znew = interpolateArray(getAxis(reading, 2), interpolateThreshold )
        return assemblyReading (xnew, ynew, znew)
      }

      function assemblyReading (x, y, z) {
        var temp = []
        for (i = 0; i < x.length; i++) {
          temp[i] = [x[i], y[i], z[i]]
        }
        return temp
      }
    
      function plot () {
        
        var d0 = interpolate(segment(smooth(data_0)))
        var d1 = interpolate(segment(smooth(data_1)))
        var d2 = interpolate(segment(smooth(data_2)))
        var d3 = interpolate(segment(smooth(data_3)))
        var d4 = interpolate(segment(smooth(data_4)))
        var d5 = interpolate(segment(smooth(data_5)))
        var d6 = interpolate(segment(smooth(data_6)))
        var d7 = interpolate(segment(smooth(data_7)))
        var d8 = interpolate(segment(smooth(data_8)))
        var d9 = interpolate(segment(smooth(data_9)))
        var dmean = getMeanData ()

        var x0 = getAxis (d0, 0)
        var x1 = getAxis (d1, 0)
        var x2 = getAxis (d2, 0)
        var x3 = getAxis (d3, 0)
        var x4 = getAxis (d4, 0)
        var x5 = getAxis (d5, 0)
        var x6 = getAxis (d6, 0)
        var x7 = getAxis (d7, 0)
        var x8 = getAxis (d8, 0)
        var x9 = getAxis (d9, 0)
        var xmean = getAxis (dmean, 0)
        
        var trace0_x = { y: x0, mode: 'lines+markers' }
        var trace1_x = { y: x1, mode: 'lines+markers' }
        var trace2_x = { y: x2, mode: 'lines+markers' }
        var trace3_x = { y: x3, mode: 'lines+markers' }
        var trace4_x = { y: x4, mode: 'lines+markers' }
        var trace5_x = { y: x5, mode: 'lines+markers' }
        var trace6_x = { y: x6, mode: 'lines+markers' }
        var trace7_x = { y: x7, mode: 'lines+markers' }
        var trace8_x = { y: x8, mode: 'lines+markers' }
        var trace9_x = { y: x9, mode: 'lines+markers' }
        var trace_mean_x = {y: xmean, mode: 'lines+markers'}

        var data_x = [trace0_x, trace1_x, trace2_x, trace3_x, trace4_x, trace5_x, trace6_x, trace7_x, trace8_x, trace9_x, trace_mean_x]
        var layout_x = {title:'x '}
        Plotly.newPlot('x', data_x, layout_x)

        var y0 = getAxis (d0, 1)
        var y1 = getAxis (d1, 1)
        var y2 = getAxis (d2, 1)
        var y3 = getAxis (d3, 1)
        var y4 = getAxis (d4, 1)
        var y5 = getAxis (d5, 1)
        var y6 = getAxis (d6, 1)
        var y7 = getAxis (d7, 1)
        var y8 = getAxis (d8, 1)
        var y9 = getAxis (d9, 1)
        var ymean = getAxis (dmean, 1)

        var trace0_y = { y: y0, mode: 'lines+markers' }
        var trace1_y = { y: y1, mode: 'lines+markers' }
        var trace2_y = { y: y2, mode: 'lines+markers' }
        var trace3_y = { y: y3, mode: 'lines+markers' }
        var trace4_y = { y: y4, mode: 'lines+markers' }
        var trace5_y = { y: y5, mode: 'lines+markers' }
        var trace6_y = { y: y6, mode: 'lines+markers' }
        var trace7_y = { y: y7, mode: 'lines+markers' }
        var trace8_y = { y: y8, mode: 'lines+markers' }
        var trace9_y = { y: y9, mode: 'lines+markers' }
        var trace_mean_y = {y: ymean, mode: 'lines+markers'}

        var data_y = [trace0_y, trace1_y, trace2_y, trace3_y, trace4_y, trace5_y, trace6_y, trace7_y, trace8_y, trace9_y, trace_mean_y]
        var layout_y = {title:'y '}
        Plotly.newPlot('y', data_y, layout_y)

        var z0 = getAxis (d0, 2)
        var z1 = getAxis (d1, 2)
        var z2 = getAxis (d2, 2)
        var z3 = getAxis (d3, 2)
        var z4 = getAxis (d4, 2)
        var z5 = getAxis (d5, 2)
        var z6 = getAxis (d6, 2)
        var z7 = getAxis (d7, 2)
        var z8 = getAxis (d8, 2)
        var z9 = getAxis (d9, 2)
        var zmean = getAxis (dmean, 2)

        var trace0_z = { y: z0, mode: 'lines+markers' }        
        var trace1_z = { y: z1, mode: 'lines+markers' }
        var trace2_z = { y: z2, mode: 'lines+markers' }
        var trace3_z = { y: z3, mode: 'lines+markers' }
        var trace4_z = { y: z4, mode: 'lines+markers' }
        var trace5_z = { y: z5, mode: 'lines+markers' }
        var trace6_z = { y: z6, mode: 'lines+markers' }
        var trace7_z = { y: z7, mode: 'lines+markers' }
        var trace8_z = { y: z8, mode: 'lines+markers' }
        var trace9_z = { y: z9, mode: 'lines+markers' }
        var trace_mean_z = {y: zmean, mode: 'lines+markers'}
       

        var data_z = [trace0_z, trace1_z, trace2_z, trace3_z, trace4_z, trace5_z, trace6_z, trace7_z, trace8_z, trace9_z, trace_mean_z]
        var layout_z = {title:'z '}
        Plotly.newPlot('z', data_z, layout_z)
      }

      function getDistance (v1, v2) {
		    return Math.sqrt (Math.pow ( (v1[0] - v2[0]), 2 ) + Math.pow ( (v1[1] - v2[1]), 2 ) + Math.pow ( (v1[2] - v2[2]), 2 ))
	    }

     </script>
   </body>
</html>