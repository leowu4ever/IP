<!DOCTYPE html>
<!--
	Demonstration of the TI SensorTag JavaScript library.
-->
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TI SensorTag CC2650 &amp; CC2541 Sensors</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.	
		if (window.hyper && window.hyper.log) { console.log = hyper.log}
	</script>
   
    <script src="crafty.js"></script>
	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
</head>

<body>
	<button onclick="connect()" class="green">Connect</button>
	<button onclick="disconnect()" class="charcoal">Disconnect</button>
	<button onclick="window.location.href='test.html'" class="yellow">Test Page</button> 	
	
	<p>
		<strong>Status:</strong> 
		<span id="StatusData">Press Connect to find the nearest SensorTag</span>
	</p>

	<h2>Accelerometer:</h2>
	<p>
		<span id="AccelerometerData">[Waiting for value]</span>
	</p>
	
	<div id="game"></div>

	<script>
	// SensorTag object.
	var sensortag

	function initialiseSensorTag()
	{
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(evothings.tisensortag.CC2650_BLUETOOTH_SMART)

		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.accelerometerCallback(accelerometerHandler, 500)
	}

	function connect()
	{
		startGame()
		sensortag.connectToNearestDevice()
	}

	function disconnect()
	{
		sensortag.disconnectDevice()
		resetSensorDisplayValues()
	}
	
	function statusHandler(status)
	{
		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)

		if (evothings.easyble.error.DISCONNECTED == error)
		{
			resetSensorDisplayValues()
		}
		else
		{
			displayValue('StatusData', 'Error: ' + error)
		}
	}

	function resetSensorDisplayValues()
	{
		var blank = '[Waiting for value]'
		displayValue('StatusData', 'Press Connect to find a SensorTag')
		displayValue('AccelerometerData', blank)
		setBackgroundColor('white')
	}
	
	function displayValue(elementId, value)
	{
		document.getElementById(elementId).innerHTML = value
	}
	
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false)	

	var init_bool = false

	var x_start = 0.0
	var y_start = 0.0
	var z_start = 0.0

	var x_pre= 0.0
	var y_pre = 0.0
	var z_pre = 0.0

	var x_offset = -0.01
	var y_offset = 0.01
	var z_offset = -0.01	
	
	var updateThreshold = 0.004
	var speed = 10
	
	// get rid of noise first so the reading are stable 
	// next set offsets 
	
	function accelerometerHandler(data)
	{
		var values = sensortag.getAccelerometerValues(data)
		
		if (!isNaN(values.x) && !isNaN(values.y) && !isNaN(values.z)) {
			
			var x = parseFloat((values.x - x_offset).toFixed(2))
			var y = parseFloat((values.y - y_offset).toFixed(2))
			var z = parseFloat((values.z - z_offset).toFixed(2))/-0.25 
			
			if (!init_bool && x!=0 && y!=0 && z!=0) {
				x_start = x
				y_start = y
				z_start = z
				
				x_pre = x
				y_pre = y
				z_pre = z
				
				init_bool = !init_bool
			}
	
		
			string =
				'X ' + (x >= 0 ? '+' : '') + x + 'G</br>' +
				'Y ' + (y >= 0 ? '+' : '') + y + 'G</br>' +
				'Z ' + (z >= 0 ? '+' : '') + z + 'G</br>'
				
			displayValue('AccelerometerData', string)
		
		}	
	}
		
	// game	
	var background
	var fish
	var score
	
	function startGame () {
		Crafty.init(Crafty.viewport.width, Crafty.viewport.height, document.getElementById('game'))
		
		background = Crafty.background('#FFFFFF url(Graphics/ocean.png) repeat center center')
		fish = Crafty.e("2D, DOM, Image").image("Graphics/fish.png").origin("center")
		score = Crafty.e("2D, DOM, Text").attr({x:100, y: 10}).text("score text")
 		//Crafty.e("2D, DOM, Image").image("Graphics/number_one.png").origin("center")
		
	}	
	</script>
</body>
</html>
