<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TI SensorTag CC2650 &amp; CC2541 Sensors</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.	
		if (window.hyper && window.hyper.log) { console.log = hyper.log}
	</script>
   	
	<script type="text/javascript" src="libs/jscharts.js"></script>
    <script src="libs/crafty.js"></script>
	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
</head>

<body>
	<button onclick="connect()" class="green">Connect</button>
	<button onclick="disconnect()" class="yellow">Disconnect</button>
	<button onclick="startReading()" class="green">Start Reading</button>
	<button onclick="stopReading()" class="red">End Reading</button>
	<button onclick="preprocess()" class="blue">Preprocess</button>
	<button onclick="printHmm()" class="blue">PrintHmm</button>


	<p>
		<strong>Status:</strong> 
		<span id="StatusData">Press Connect to find the nearest SensorTag</span>
	</p>

	<h2>Accelerometer:</h2>
	<p>
		<span id="AccelerometerData">[Waiting for value]</span>
	</p>
	
	<div id="game"></div>

	<script>
		var sensortag
		var isReading
		
		var record
		
		function startReading() 
		{
			isReading = true	
		}
		
		function stopReading() 
		{
			isReading = false
			hyper.log(record)
			record = ""

		}
		
		function initialiseSensorTag()
		{
			// Create SensorTa	g CC2650 instance.
			sensortag = evothings.tisensortag.createInstance(evothings.tisensortag.CC2650_BLUETOOTH_SMART)

			sensortag
				.statusCallback(statusHandler)
				.errorCallback(errorHandler)
				.accelerometerCallback(accelerometerHandler, 100)
		}

		function connect()
		{
			//startGame()
			sensortag.connectToNearestDevice()
		}

		function disconnect()
		{
			sensortag.disconnectDevice()
			resetSensorDisplayValues()
		}
		
		function statusHandler(status)
		{
			displayValue('StatusData', status)
		}

		function errorHandler(error)
		{
			console.log('Error: ' + error)

			if (evothings.easyble.error.DISCONNECTED == error)
			{
				resetSensorDisplayValues()
			}
			else
			{
				displayValue('StatusData', 'Error: ' + error)
			}
		}

		function resetSensorDisplayValues()
		{
			var blank = '[Waiting for value]'
			displayValue('StatusData', 'Press Connect to find a SensorTag')
			displayValue('AccelerometerData', blank)
		}
		
		function displayValue(elementId, value)
		{
			document.getElementById(elementId).innerHTML = value
		}
		
		document.addEventListener(
			'deviceready',
			function() { evothings.scriptsLoaded(initialiseSensorTag) },
			false)	

		var x_offset = -0.01
		var y_offset = 0.01
		var z_offset = -0.01	
		var string = ""
		// get rid of noise first so the reading are stable 
		// next set offsets 
		
		function accelerometerHandler(data)
		{
			if (isReading) {
				var values = sensortag.getAccelerometerValues(data)
				if (!isNaN(values.x) && !isNaN(values.y) && !isNaN(values.z)) {
					
					var x = parseFloat((values.x - x_offset).toFixed(2))
					var y = parseFloat((values.y - y_offset).toFixed(2))
					var z = parseFloat((values.z - z_offset).toFixed(2))/-0.25 
					var pitch = Math.atan(y/Math.sqrt(Math.pow(x,2) + Math.pow(z,2))) * (180.0/Math.PI)
					var roll = Math.atan(x/Math.sqrt(Math.pow(y,2) + Math.pow(z,2))) * (180.0/Math.PI)
					
					record =  roll + "," + record	
					string = 'X ' + (x >= 0 ? '+' : '') + x + 'G</br>' +
							 'Y ' + (y >= 0 ? '+' : '') + y + 'G</br>' +
						     'Z ' + (z >= 0 ? '+' : '') + z + 'G</br>' +
							 'pitch : ' + pitch + '<br/>' +
 							 'roll : ' + roll + '<br/>'
						
					displayValue('AccelerometerData', string)
				}				
			}
		}
				
		function thresholdFilter () 
		{
			
		}		
				
		// hmm
		var startProb = [0,1,2];
		var transitionProb = [[0,1],[0,1]];
		var observationProb = [[0,1,2],[0,1,5]];
		var observations = [0.1, 0.2, 0.3]
		var n = 14
		var m = 1
		var trainingData = [[0.1, 0.2, 0.3], [0.4, 0.5, 0.6]]
		var filterThreshold = 0.2
		
		function preprocess () {
			denoise (trainingData)	
		}
		
		function denoise (reading) {
			
			hyper.log ("trainingdata length before: " + trainingData.length)
			for (var i = 0; i<reading.length; i++) {
				if (i != 0) {
					if (Math.sqrt (Math.pow (reading[i][0] - reading[i-1][0], 2) +
								   Math.pow (reading[i][1] - reading[i-1][1], 2) +
								   Math.pow (reading[i][2] - reading[i-1][2], 2)) < filterThreshold ) {
									   
									   reading.splice (i,1)
								   }
				} else {
					if (Math.sqrt (Math.pow (reading[i][0] - 0, 2) +
								   Math.pow (reading[i][1] - 0, 2) +
								   Math.pow (reading[i][2] - 0, 2)) < filterThreshold ) {
									   
									   reading.splice (i,1)
								   }
				}	
			}
			hyper.log ("trainingdata length after: " + trainingData.length)
			printMatrix (trainingData)
			
		}
		
		function train () {
		}
		
		function recognise () {
		}
		
		function initHmmForTraining () {
			
		}
		
		function initHmmForRecognising () {
			
			
		}
		
		function printHmm () {
			hyper.log ("--- start prob ---")
			hyper.log (startProb)	
			hyper.log ("--- start prob ---" + '\n')
			
			hyper.log ("--- trainsition prob ---")
			printMatrix (transitionProb)	
			hyper.log ("--- trainsition prob ---" + '\n')
			
			hyper.log ("--- observation prob ---")
			printMatrix (observationProb)	
			hyper.log ("--- observation prob ---" + '\n')
			
			hyper.log ("n = " + n + '\n')
			hyper.log ("m = " + m + '\n')
			printMatrix(trainingData)
		}
		
		function printMatrix (matrix) {
			var temp = ""
			for(var i = 0; i < matrix.length; i++) {
				for(var j = 0; j < matrix[i].length; j++) {
					if (j!=matrix[i].length-1) {
						temp = temp + matrix[i][j] + "," 
					} else {
						temp = temp + matrix[i][j]
						
					}
				}
				if (i!=matrix.length-1) {
					temp = temp + '|'
				} else {
					temp = temp 
				}
			}
			hyper.log(temp)
		}
		
		
		// game	
		var background
		var fish
		var score
		var speed = 10
		
		function startGame () {
			Crafty.init(Crafty.viewport.width, Crafty.viewport.height, document.getElementById('game'))
			
			background = Crafty.background('#FFFFFF url(Graphics/ocean.png) repeat center center')
			fish = Crafty.e("2D, DOM, Image").image("Graphics/fish.png").origin("center")
			score = Crafty.e("2D, DOM, Text").attr({x:100, y: 10}).text("score text")
			//Crafty.e("2D, DOM, Image").image("Graphics/number_one.png").origin("center")
		}	
	</script>
</body>
</html>
