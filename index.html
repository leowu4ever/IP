<!DOCTYPE html>
<!--
	Demonstration of the TI SensorTag JavaScript library.
-->
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TI SensorTag CC2650 &amp; CC2541 Sensors</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.	
	if (window.hyper && window.hyper.log) { console.log = hyper.log}
	</script>

	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
</head>

<body>
	<button onclick="window.location.href='test.html'" class="yellow">
		Start
	</button> 
	
	<button onclick="connect()" class="green">
		Connect
	</button>

	<button onclick="disconnect()" class="charcoal">
		Disconnect
	</button>

	<p>
		<strong>Status:</strong> <span id="StatusData">Press Connect to find the nearest SensorTag</span>
	</p>

	<h2>Accelerometer:</h2>
	<p>
		<span id="AccelerometerData">[Waiting for value]</span>
	</p>

	<h2>Gyroscope:</h2>
	<p>
		<span id="GyroscopeData">[Waiting for value]</span>
	</p>

	<script>
	// SensorTag object.
	var sensortag

	function initialiseSensorTag()
	{
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(
			evothings.tisensortag.CC2650_BLUETOOTH_SMART)

		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.accelerometerCallback(accelerometerHandler, 200)
			.gyroscopeCallback(gyroscopeHandler, 1000)
	}

	function connect()
	{
		sensortag.connectToNearestDevice()
	}

	function disconnect()
	{
		sensortag.disconnectDevice()
		resetSensorDisplayValues()
	}
	
	function statusHandler(status)
	{
		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)

		if (evothings.easyble.error.DISCONNECTED == error)
		{
			resetSensorDisplayValues()
		}
		else
		{
			displayValue('StatusData', 'Error: ' + error)
		}
	}

	function resetSensorDisplayValues()
	{
		// Clear current values.
		var blank = '[Waiting for value]'
		displayValue('StatusData', 'Press Connect to find a SensorTag')
		displayValue('AccelerometerData', blank)
		displayValue('GyroscopeData', blank)

		// Reset screen color.
		setBackgroundColor('white')
	}

	var x_last = 0;
	var y_last = 0;
	var z_last = 0;
	
	var xOffset = 0.0
	var yOffset = 0.0
	var zOffset = 0.0	
	
	var noiseThreshold = 0.015;
	
	function accelerometerHandler(data)
	{
		// Calculate the x,y,z accelerometer values from raw data.
		var values = sensortag.getAccelerometerValues(data)
		var x = (values.x - xOffset)
		var y = values.y - yOffset
		var z = (values.z - zOffset)/0.258
		
		if (Math.abs(x-x_last) < noiseThreshold) 
		{
			x = x_last;
		} 
		if (Math.abs(y-y_last) < noiseThreshold) 
		{
			y = y_last;
		} 
		if (Math.abs(z-z_last) < noiseThreshold) 
		{
			z = z_last;
		} 
		
		var pitch = Math.atan(x/Math.sqrt(Math.pow(y,2) + Math.pow(z,2))) * (180.0/Math.PI);;
		var roll = Math.atan(y/Math.sqrt(Math.pow(x,2) + Math.pow(z,2))) * (180.0/Math.PI);;
		
		// Prepare the information to display.
		string =
			'x : ' + (x >= 0 ? '+' : '') + x.toFixed(2) + 'G<br/>' +
			'y : ' + (y >= 0 ? '+' : '') + y.toFixed(2) + 'G<br/>' +
			'z : ' + (z >= 0 ? '+' : '') + z.toFixed(2) + 'G<br/>' + 
			'pitch : ' + pitch.toFixed(0) + '<br/>' +
			'roll : ' + roll.toFixed(0) + '<br/>'
			
		// Update the value displayed.
		displayValue('AccelerometerData', string)
		
		x_last = x;
		y_last = y;
		z_last = z;
	}
	
	function gyroscopeHandler(data)
	{
		// Calculate the gyroscope values from raw sensor data.
		var values = sensortag.getGyroscopeValues(data)
		var x = values.x
		var y = values.y
		var z = values.z

		// Prepare the information to display.
		string =
			'x : ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '<br/>' +
			'y : ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '<br/>' +
			'z : ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '<br/>'

		// Update the value displayed.
		displayValue('GyroscopeData', string)
	}

	function displayValue(elementId, value)
	{
		document.getElementById(elementId).innerHTML = value
	}
	
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false)
	
	</script>
</body>
</html>
