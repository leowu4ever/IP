<!DOCTYPE html>
<!--
	Demonstration of the TI SensorTag JavaScript library.
<--></-->
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TI SensorTag CC2650 &amp; CC2541 Sensors</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>
   	<script src="libs/plotly-latest.min.js"></script>
	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
</head>

<body>

	<header>
		<button class="back" onclick="history.back()">
			<img src="ui/images/arrow-left.svg" />
		</button>
		<img class="logotype" src="ui/images/logo.svg" alt="Evothings" />
		<!--<button class="menu" onclick=""><img src="ui/images/menu.svg" /></button>-->
	</header>

	<p id="upgradeNotice" class="hidden">
		<span class="color_softred">Please upgrade the firmware of your SensorTag.</span>
	</p>

	<button onclick="connect()" class="green">
		connect
	</button>

	<button onclick="disconnect()" class="charcoal">
		disconnect
	</button>

	<button onclick="test()" class="charcoal">
		test
	</button>

	<p>
		<strong>Status:</strong> <span id="StatusData">Press Connect to find the nearest SensorTag</span>
	</p>

	<h2>Accelerometer:</h2>
	<p>
		<span id="AccelerometerData">[Waiting for value]</span>
	</p>

	<h2>Device info:</h2>
	<p>
		SensorTag device model: <span id="DeviceModel">?</span><br />
		Firmware version: <span id="FirmwareData">?</span>
	</p>

	<div id="myDiv" style="width: 300px; height: 300px;"><!-- Plotly chart will be drawn inside this DIV --></div>

	<script>

		
	// SensorTag object.
	var sensortag
	function initialiseSensorTag()
	{
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(evothings.tisensortag.CC2650_BLUETOOTH_SMART)
		sensortag.statusCallback(statusHandler)
				 .errorCallback(errorHandler)
				 .keypressCallback(keypressHandler)
			 	 .accelerometerCallback(accelerometerHandler, 100)
	}

	function connect() { sensortag.connectToNearestDevice() }

	function disconnect()
	{
		sensortag.disconnectDevice()
		resetSensorDisplayValues()
	}

	function statusHandler(status)
	{
		if ('DEVICE_INFO_AVAILABLE' == status)
		{
			var upgradeNotice = document.getElementById('upgradeNotice')
			if ('CC2541' == sensortag.getDeviceModel() &&
				parseFloat(sensortag.getFirmwareString()) < 1.5)
			{
				upgradeNotice.classList.remove('hidden')
			}
			else
			{
				upgradeNotice.classList.add('hidden')
			}

			// Show device model and firmware version.
			displayValue('DeviceModel', sensortag.getDeviceModel())
			displayValue('FirmwareData', sensortag.getFirmwareString())

			// Show which sensors are not supported by the connected SensorTag.
			if (!sensortag.isLuxometerAvailable())
			{
				document.getElementById('Luxometer').style.display = 'none'
			}
		}

		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)

		if (evothings.easyble.error.DISCONNECTED == error)
		{
			resetSensorDisplayValues()
		}
		else
		{
			displayValue('StatusData', 'Error: ' + error)
		}
	}
	var recording = false

	function keypressHandler(data)
	{
		// Update background color.
		if(data[0] == 1) {
			recording = !recording
			if (recording) {hyper.log("Start recording...")} else {hyper.log ("Done recording...")}
		}
	}

	function resetSensorDisplayValues()
	{
		// Clear current values.
		var blank = '[Waiting for value]'
		displayValue('StatusData', 'Press Connect to find a SensorTag')
		displayValue('DeviceModel', '?')
		displayValue('FirmwareData', '?')
		displayValue('AccelerometerData', blank)
		// Reset screen color.
	}
	var x_offset = -0.004
	var y_offset = 0.0
	var z_offset = -0.01
	var recordStartTime = 0.0
	var record = []

	function accelerometerHandler (data)
	{	
		if (recording) { // if it is recording 
			var values = sensortag.getAccelerometerValues(data)
			if (!isNaN (values.x) && !isNaN (values.y) && !isNaN (values.z)) {
				if (record.length == 0) {
					recordStartTime = Date.now()/1000
				}
				var x = parseFloat ((values.x - x_offset).toFixed(2))
				var y = parseFloat ((values.y - y_offset).toFixed(2))
				var z = parseFloat (((values.z - z_offset)/0.2585).toFixed(2))
				record.push ([x, y, z])
				string = 'x: ' + (x >= 0 ? '+' : '') + x + 'G<br/>' + 'y: ' + (y >= 0 ? '+' : '') + y + 'G<br/>' + 'z: ' + (z >= 0 ? '+' : '') + z + 'G<br/>' 
				displayValue('AccelerometerData', string)
			}
		} else {
			if(record.length != 0) {
				hyper.log ( "Duration : " + ((Date.now()/1000) - recordStartTime) + " " + record.length + "recorded" )
				printReading (record)
				record = []
			}
		}
	}

	function getAxis (reading, axis) {
        var axis_record = []
        for (i = 0; i < reading.length; i++) { axis_record.push (reading[i][axis]) }
        return axis_record
    }
	
	function getDistance (v1, v2) { return Math.sqrt (Math.pow ( (v1[0] - v2[0]), 2 ) + Math.pow ( (v1[1] - v2[1]), 2 ) + Math.pow ( (v1[2] - v2[2]), 2 )) }

	function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min)) + min }

	function printReading (reading) {
		var log = ""
		for (i = 0; i < reading.length; i++) {
			if ( i != reading.length -1 ) { log += "[" + reading[i] + "]" + "," } 
			else { log += "[" + reading[i] + "]" }
		}
		hyper.log (log)
	}
	
	function printMatrix (matrix) {
		var temp = ""
		for( i = 0; i < matrix.length; i++) {
			for( j = 0; j < matrix[i].length; j++) {
				if (j!=matrix[i].length-1) {
					temp = temp + matrix[i][j] + "," 
				} else {
					temp = temp + matrix[i][j]
				}
			} 
			hyper.log(temp) 
			temp = ""
		}
	}
	
	function zerosMatrix (row, column) {
		var matrix = new Array (row)
		for (i = 0; i < row; i++) {
			matrix[i] = new Array (column)
		}
		for (i = 0; i < row; i++) {
			for (j = 0; j < column; j++) {
				matrix [i][j] = 0
			}
		}
		return matrix
	}

	function zerosScales (length) {
		var scales = new Array (length)
		for (i = 0; i < length; i++) {
			scales[i] = 0
		}
		return scales
	}

	function sumOfColumn (matrix, column) {
		var sum = 0
		for (i = 0; i < matrix.length; i++) {
			sum += matrix[i][column]
		}
		return sum
	}

	function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min)) + min }

	function minIndex(arr) {
		if (!arr || arr.length === 0) {
			return -1;
		}
		var min = arr[0];
		var minIndex = 0;
		for (var len = arr.length; len > 0; len--) {
			if (arr[len] < min) {
				min = arr[len];
				minIndex = len;
			}
		}
		return minIndex;
	}

	function displayValue (elementId, value) { document.getElementById(elementId).innerHTML = value }

	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false)
	</script>

</body>

</html>
