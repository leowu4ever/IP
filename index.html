<!DOCTYPE html>
<!--
	Demonstration of the TI SensorTag JavaScript library.
-->
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TI SensorTag CC2650 &amp; CC2541 Sensors</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.	
	if (window.hyper && window.hyper.log) { console.log = hyper.log}
	</script>
   
    <script src="crafty.js"></script>
	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
</head>

<body>

	
	<button onclick="connect()" class="green">Connect</button>

	<button onclick="disconnect()" class="charcoal">Disconnect</button>
	
	<button onclick="window.location.href='test.html'" class="yellow">Test Page</button> 	
	
	<p>
		<strong>Status:</strong> 
		<span id="StatusData">Press Connect to find the nearest SensorTag</span>
	</p>

	<h2>Accelerometer:</h2>
	<p>
		<span id="AccelerometerData">[Waiting for value]</span>
	</p>
	
	<div id="game"></div>

	<script>
	// SensorTag object.
	var sensortag

	function initialiseSensorTag()
	{
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(
			evothings.tisensortag.CC2650_BLUETOOTH_SMART)

		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.accelerometerCallback(accelerometerHandler, 200)
	}

	function connect()
	{
		startGame()
		sensortag.connectToNearestDevice()
	}

	function disconnect()
	{
		sensortag.disconnectDevice()
		resetSensorDisplayValues()
	}
	
	function statusHandler(status)
	{
		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)

		if (evothings.easyble.error.DISCONNECTED == error)
		{
			resetSensorDisplayValues()
		}
		else
		{
			displayValue('StatusData', 'Error: ' + error)
		}
	}

	function resetSensorDisplayValues()
	{
		// Clear current values.
		var blank = '[Waiting for value]'
		displayValue('StatusData', 'Press Connect to find a SensorTag')
		displayValue('AccelerometerData', blank)

		// Reset screen color.
		setBackgroundColor('white')
	}
	
	function displayValue(elementId, value)
	{
		document.getElementById(elementId).innerHTML = value
	}
	
	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false)	

	var x_last = 0
	var y_last = 0
	var z_last = 0
	var pitch_last = 0
	var roll_last = 0
	
	var xOffset = 0.0
	var yOffset = 0.0
	var zOffset = 0.0	
	
	var noiseThreshold = 0.015
	var rotationThreshold = 1
	
	function accelerometerHandler(data)
	{
		// Calculate the x,y,z accelerometer values from raw data.
		var values = sensortag.getAccelerometerValues(data)
		
		var x = (values.x - xOffset)
		var y = values.y - yOffset
		var z = (values.z - zOffset)/0.258
		var pitch = Math.atan(x/Math.sqrt(Math.pow(y,2) + Math.pow(z,2))) * (180.0/Math.PI)
		var roll = Math.atan(y/Math.sqrt(Math.pow(x,2) + Math.pow(z,2))) * (180.0/Math.PI)
		
		if (Math.abs(x - x_last) < noiseThreshold) 
		{
			x = x_last
		} 
		if (Math.abs(y - y_last) < noiseThreshold) 
		{
			y = y_last
		} 
		if (Math.abs(z - z_last) < noiseThreshold) 
		{
			z = z_last
		} 
		if (Math.abs(pitch - pitch_last) < rotationThreshold) 
		{
			pitch = pitch_last
		}
		if (Math.abs(roll - roll_last) < rotationThreshold) 
		{
			roll = roll_last
		}

		// Prepare the information to display.
		string =
			'X ' + (x >= 0 ? '+' : '') + x.toFixed(2) + 'G ' +
			'Y ' + (y >= 0 ? '+' : '') + y.toFixed(2) + 'G ' +
			'Z ' + (z >= 0 ? '+' : '') + z.toFixed(2) + 'G ' + 
			'Pitch ' + pitch.toFixed(0) + ' ' +
			'Roll ' + roll.toFixed(0)
			
		// Update the value displayed.
		displayValue('AccelerometerData', string)
		
		fish.bind('EnterFrame', function() {
			this.y = this.y + (pitch - pitch_last) * speed
			this.x = this.x + (roll - roll_last) * speed
		})
					
		x_last = x
		y_last = y
		z_last = z
		pitch_last = pitch
		roll_last = roll
	}
		
	// game
	var speed = 0.0001
	
	var background
	var fish
	var score
	
	function startGame () {
		Crafty.init(Crafty.viewport.width, Crafty.viewport.height, document.getElementById('game'))
		
		background = Crafty.background('#FFFFFF url(Graphics/ocean.png) repeat center center')
		fish = Crafty.e("2D, DOM, Image").image("Graphics/fish.png").origin("center")
		score = Crafty.e("2D, DOM, Text").attr({x:100, y: 10}).text("score text")
	}	
	</script>
</body>
</html>
