<html>
  <head>
    
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width, user-scalable=no,
      shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
      
    <style>
      @import 'ui/css/evothings-app.css';
    </style>

    <script>
    // Redirect console.log to Evothings Workbench.	
    if (window.hyper && window.hyper.log) { console.log = hyper.log}
    </script>
   	<script src="libs/plotly-latest.min.js"></script>
    <script src="cordova.js"></script>
    <script src="crafty.js"></script>
    <script src="libs/evothings/evothings.js"></script>
    <script src="libs/evothings/ui/ui.js"></script>
  	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
    
  </head>
   
   <body>
    <div>
     <button onclick="window.location.href='index.html'" class="green">
	       Back
	   </button>
      <button onclick="plot()" class="green">
	       plot
	   </button>
    </div>
    
   	 <div id="x" style="width: 500px; height: 500px; float:left"><!-- Plotly chart will be drawn inside this DIV --></div>
     <div id="z" style="width: 500px; height: 500px; float:right"><!-- Plotly chart will be drawn inside this DIV --></div>
   	 <div id="y" style="width: 500px; height: 500px; margin: 0 auto"><!-- Plotly chart will be drawn inside this DIV --></div>

     <script>
      data_1 = [[0,0,0.99],[0,0.03,1.02],[0,0,0.99],[0,0.02,0.99],[0,0.01,1],[0,0.01,0.99],[-0.01,0.01,0.99],[-0.01,-0.01,0.98],[0.02,0.03,0.99],[-0.02,0.01,1.01],[-0.01,0,0.99],[-0.01,-0.01,0.99],[-0.02,-0.02,0.99],[-0.01,0,0.98],[-0.01,-0.02,1],[-0.01,0,0.99]]
      data_2 = [[0,0.01,1],[0,0.01,1],[0,0,1],[0,0,1.01],[-0.01,0.02,0.98],[0,0.01,0.99],[-0.01,0.02,0.97],[-0.01,0.02,1],[-0.01,-0.02,1],[0,0.02,0.98],[-0.01,0,0.99],[0,-0.01,1],[-0.01,0.01,1.01],[-0.01,0,0.97],[-0.01,-0.01,1],[-0.01,0.01,0.99],[-0.01,0,0.99],[-0.01,0,1],[-0.01,0,0.99],[-0.01,0,0.99]]
      data_3 = [[0,0.01,0.99],[0,0.01,0.99],[0,0.01,0.99],[-0.01,0.02,1],[0,0.01,1],[0,0,0.99],[0,0,0.99],[-0.01,0,0.99],[0,0.01,0.99],[0,0.02,0.99],[-0.01,-0.01,1],[-0.01,0.01,0.99],[0,0,0.99],[-0.01,0.01,0.99],[0,0,1],[-0.01,-0.02,1],[-0.01,0,0.99],[-0.01,-0.01,1],[0,0.02,0.99],[-0.01,0,0.99]]
      data_4 = [[0,0,0.99],[0,0,1],[0,0,0.99],[-0.01,0.01,1],[-0.01,0.01,1],[0,0.01,1],[-0.01,0,0.99],[-0.01,0,0.99],[-0.01,0,0.99],[0,0.01,0.99],[-0.01,0,1],[-0.01,-0.01,1],[-0.01,0.01,0.99],[-0.01,0,1],[-0.01,-0.01,0.99],[-0.01,0.02,0.99],[-0.01,0,1],[0,0,1],[-0.01,0,0.99]]
      data_5 = [[0,0,0.99],[0,0,1],[0,0,0.99],[-0.01,0.01,0.99],[0,0.01,1],[0,0.01,0.99],[-0.01,-0.01,0.99],[-0.01,0.01,1],[-0.01,0.02,0.99],[0,0,1],[-0.01,0,0.98],[-0.01,0,0.99],[-0.01,0.01,1],[0,-0.01,0.99],[-0.01,0,0.99],[-0.01,0,1],[-0.01,0.01,0.99],[0,-0.01,0.99],[-0.01,-0.01,0.99],[-0.01,0,1]]

      var segmentUpperBound = 0.3
      var segmentLowerBound = 0.1
      function segmentData (reading) {
        var temp = []
        var keep = false
        for (i = 0; i < reading.length; i++) {
          if (getDistance (reading[i], reading[i+1]) > segmentUpperBound) { keep = true } 
          if (getDistance (reading[i], reading[i+1]) < segmentLowerBound) { keep = false }
          if (keep) { temp.push (reading[i])}
          return temp
        }
      }
      
      var truncationThreshold = 0.22
      function truncateData (reading) {
        var limit = truncationThreshold * Math.sqrt (getSD(reading))

        for (i = 0; i < reading; i++) {
          if (reading[i] < limit) { reading.splice(i, 1) }
        }
        return reading
      }

      function getSD (reading) {
        var mean
        for (i = 0; i < reading.length; i++) {
          mean += getMagnitude(reading[i])
        }
        mean /= reading.length

        var sumOfDifference
        for (j = 0; j < reading.length; j++) {
          sumOfDifference += (getMagnitude(reading[j]) - mean) * (getMagnitude(reading[j]) - mean)
        }

        var sd = Math.sqrt (sumOfDifference)
        return sd
      }

      function getMagnitude (data) { return Math.sqrt(data[0] * data[0] + data[1] * data[1] + data[2] * data[2]) }

      var smoothThreshold = 0.3
      function smoothData (reading) {
        var smoothReading = []
        for (i = 0; i < reading.length; i++) {
          v_x = reading[i][0]
          v_y = reading[i][1]
          v_z = reading[i][2]
          if (i == 0) {
            smoothReading.push ([v_x, v_y, v_z])
          } else {
            s_x = smoothReading[i-1][0]
            s_y = smoothReading[i-1][1]
            s_z = smoothReading[i-1][2]
            smoothReading.push ([ (s_x + smoothThreshold * (v_x - s_x)), (s_y + smoothThreshold * (v_y - s_y)), (s_z + smoothThreshold * (v_z - s_z)) ])
          }
        }
        return smoothReading
      }
      
      function getAxis (reading, axis) {
        var axis_record = []
        for (i = 0; i < reading.length; i++) {
          axis_record.push (reading[i][axis])
        }
        return axis_record
      }

      function plot () {
        
        var d1 = smoothData(data_1)
        var d2 = smoothData(data_2)
        var d3 = smoothData(data_3)
        var d4 = smoothData(data_4)
        var d5 = smoothData(data_5)
        
        var x1 = getAxis (d1, 0)
        var x2 = getAxis (d2, 0)
        var x3 = getAxis (d3, 0)
        var x4 = getAxis (d4, 0)
        var x5 = getAxis (d5, 0)
        var trace1_x = { y: x1, mode: 'lines+markers' }
        var trace2_x = { y: x2, mode: 'lines+markers' }
        var trace3_x = { y: x3, mode: 'lines+markers' }
        var trace4_x = { y: x4, mode: 'lines+markers' }
        var trace5_x = { y: x5, mode: 'lines+markers' }
        var data_x = [trace1_x, trace2_x, trace3_x, trace4_x, trace5_x]
        var layout_x = {title:'x smooth'}
        Plotly.newPlot('x', data_x, layout_x)

        var y1 = getAxis (d1, 1)
        var y2 = getAxis (d2, 1)
        var y3 = getAxis (d3, 1)
        var y4 = getAxis (d4, 1)
        var y5 = getAxis (d5, 1)
        var trace1_y = { y: y1, mode: 'lines+markers' }
        var trace2_y = { y: y2, mode: 'lines+markers' }
        var trace3_y = { y: y3, mode: 'lines+markers' }
        var trace4_y = { y: y4, mode: 'lines+markers' }
        var trace5_y = { y: y5, mode: 'lines+markers' }
        var data_y = [trace1_y, trace2_y, trace3_y, trace4_y, trace5_y]
        var layout_y = {title:'y smooth'}
        Plotly.newPlot('y', data_y, layout_y)

        var z1 = getAxis (d1, 2)
        var z2 = getAxis (d2, 2)
        var z3 = getAxis (d3, 2)
        var z4 = getAxis (d4, 2)
        var z5 = getAxis (d5, 2)
        var trace1_z = { y: z1, mode: 'lines+markers' }
        var trace2_z = { y: z2, mode: 'lines+markers' }
        var trace3_z = { y: z3, mode: 'lines+markers' }
        var trace4_z = { y: z4, mode: 'lines+markers' }
        var trace5_z = { y: z5, mode: 'lines+markers' }
        var data_z = [trace1_z, trace2_z, trace3_z, trace4_z, trace5_z]
        var layout_z = {title:'z smooth'}
        Plotly.newPlot('z', data_z, data_z)
      }

      function getDistance (v1, v2) {
		    return Math.sqrt (Math.pow ( (v1[0] - v2[0]), 2 ) + Math.pow ( (v1[1] - v2[1]), 2 ) + Math.pow ( (v1[2] - v2[2]), 2 ))
	    }

     </script>
   </body>
</html>